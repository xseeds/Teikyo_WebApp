<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API 接続テスト</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
    }
    .error {
      background: #fee2e2;
      border-left: 4px solid #ef4444;
    }
    .info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f9fafb;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 WebChatBot Teikyo - API 接続テスト</h1>
    
    <div class="test-section">
      <h2>1. サーバー接続テスト</h2>
      <button onclick="testServerConnection()">サーバー接続を確認</button>
      <div id="server-result"></div>
    </div>
    
    <div class="test-section">
      <h2>2. 設定 API テスト</h2>
      <button onclick="testConfigAPI()">GET /api/config</button>
      <div id="config-result"></div>
    </div>
    
    <div class="test-section">
      <h2>3. セッション API テスト</h2>
      <button onclick="testSessionAPI()">POST /api/session</button>
      <div id="session-result"></div>
      <div class="info" style="margin-top: 10px;">
        ⚠️ このテストは実際に OpenAI API を呼び出します（課金される可能性があります）
      </div>
    </div>
    
    <div class="test-section">
      <h2>4. 設定ファイル確認</h2>
      <button onclick="checkConfig()">config.yaml の状態を確認</button>
      <div id="config-check-result"></div>
    </div>
  </div>
  
  <script>
    async function testServerConnection() {
      const result = document.getElementById('server-result');
      result.innerHTML = '<div class="info">テスト中...</div>';
      
      try {
        const response = await fetch('http://localhost:3001/api/config', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          result.innerHTML = `<div class="success">✅ サーバー接続成功！\nステータス: ${response.status}</div>`;
        } else {
          result.innerHTML = `<div class="error">❌ サーバーエラー\nステータス: ${response.status}</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">❌ サーバーに接続できません\n\nエラー: ${error.message}\n\n確認事項:\n1. サーバーが起動していますか？ (npm run dev)\n2. ポート 3001 が使用可能ですか？</div>`;
      }
    }
    
    async function testConfigAPI() {
      const result = document.getElementById('config-result');
      result.innerHTML = '<div class="info">テスト中...</div>';
      
      try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        if (response.ok) {
          result.innerHTML = `<div class="success">✅ 設定取得成功！\n\n${JSON.stringify(data, null, 2)}\n\nモデル数: ${data.models?.length || 0}\nボイス数: ${data.voices?.length || 0}\nRAG有効: ${data.ragEnabled}</div>`;
        } else {
          result.innerHTML = `<div class="error">❌ エラー\n\n${JSON.stringify(data, null, 2)}</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">❌ リクエスト失敗\n\n${error.message}</div>`;
      }
    }
    
    async function testSessionAPI() {
      const result = document.getElementById('session-result');
      result.innerHTML = '<div class="info">テスト中... (OpenAI API に接続します)</div>';
      
      try {
        const response = await fetch('/api/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-realtime-2025-08-28',
            voice: 'alloy',
            useRag: false
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          result.innerHTML = `<div class="success">✅ セッション作成成功！\n\n${JSON.stringify(data, null, 2)}</div>`;
        } else {
          result.innerHTML = `<div class="error">❌ セッション作成失敗\n\nステータス: ${response.status}\n\n${JSON.stringify(data, null, 2)}\n\n確認事項:\n1. config.yaml に正しい API キーが設定されていますか？\n2. OpenAI アカウントに残高がありますか？\n3. Realtime API へのアクセス権がありますか？</div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="error">❌ リクエスト失敗\n\n${error.message}</div>`;
      }
    }
    
    async function checkConfig() {
      const result = document.getElementById('config-check-result');
      result.innerHTML = '<div class="info">確認中...</div>';
      
      try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        let message = '📋 設定状態:\n\n';
        message += `✓ モデル選択肢: ${data.models?.length || 0}個\n`;
        message += `  ${data.models?.join('\n  ') || '(なし)'}\n\n`;
        message += `✓ ボイス選択肢: ${data.voices?.length || 0}個\n`;
        message += `  ${data.voices?.join(', ') || '(なし)'}\n\n`;
        message += `✓ RAG機能: ${data.ragEnabled ? '有効' : '無効'}\n`;
        message += `✓ システムプロンプト: ${data.systemPreview?.substring(0, 60) || '(なし)'}...\n`;
        
        result.innerHTML = `<div class="success">${message}</div>`;
      } catch (error) {
        result.innerHTML = `<div class="error">❌ 確認失敗\n\n${error.message}\n\nconfig/config.yaml が存在し、正しく設定されているか確認してください。</div>`;
      }
    }
    
    // ページ読み込み時に自動テスト
    window.addEventListener('load', () => {
      setTimeout(() => {
        testServerConnection();
      }, 500);
    });
  </script>
</body>
</html>

